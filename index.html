<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Custom Clean Tracker — Manual Challenge</title>
  <link rel="manifest" href="manifest.json">
  <link rel="icon" href="icons/icon-72.svg">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">
  <meta name="theme-color" content="#071227">
  <style>
    :root{
      --bg:#0b1220; --card:#071027; --glass:rgba(255,255,255,0.03);
      --muted:#9aa7bd; --accent1:#60a5fa; --accent2:#7dd3fc; --good:#10b981; --bad:#f97316;
      --success-grad:linear-gradient(90deg,var(--accent1),var(--accent2));
    }
    *{box-sizing:border-box;font-family:Inter,system-ui,-apple-system,'Segoe UI',Roboto,'Helvetica Neue',Arial}
    html,body{height:100%;margin:0;background:radial-gradient(1200px 600px at 10% 10%, rgba(96,165,250,0.06), transparent), linear-gradient(180deg,#020617 0%, #071227 100%);color:#e6eef8}
    .container{max-width:1100px;margin:36px auto;padding:28px}
    .grid{display:grid;grid-template-columns:1fr 420px;gap:20px}
    .card{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));border-radius:16px;padding:18px;box-shadow:0 8px 30px rgba(2,6,23,0.6);border:1px solid rgba(255,255,255,0.03)}
    header{display:flex;align-items:center;justify-content:space-between;margin-bottom:12px;flex-wrap:wrap;gap:10px}
    h1{margin:0;font-weight:800;letter-spacing:-0.5px}
    .subtitle{color:var(--muted);font-size:13px;margin-top:4px}
    .btn{background:var(--success-grad);border:0;padding:8px 12px;border-radius:10px;color:#03212a;font-weight:600;cursor:pointer}
    .btn.ghost{background:transparent;border:1px solid rgba(255,255,255,0.04);color:var(--muted)}
    .muted{color:var(--muted);font-size:13px}
    .progress{height:12px;background:rgba(255,255,255,0.04);border-radius:999px;overflow:hidden;margin-top:12px}
    .bar{height:100%;width:0;background:var(--success-grad)}
    .timeline{display:flex;flex-wrap:wrap;gap:6px;margin-top:12px}
    .dot{width:12px;height:12px;border-radius:50%}
    .dot.clean{background:var(--good)}
    .dot.not{background:var(--bad)}
    .dot.empty{background:rgba(255,255,255,0.04)}
    .stat{background:rgba(255,255,255,0.02);padding:10px;border-radius:12px;min-width:120px;margin-top:8px}
    .stat .num{font-weight:700;font-size:18px}
    .history{margin-top:12px;max-height:320px;overflow:auto;padding-right:6px}
    .entry{display:flex;align-items:flex-start;gap:10px;padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,0.02);margin-bottom:8px;background:linear-gradient(180deg, rgba(0,0,0,0.02), transparent)}
    .modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(2,6,23,0.85)}
    .sheet{background:#071227;padding:18px;border-radius:12px;width:360px}
    input{width:100%;padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:inherit}
    @media(max-width:900px){.grid{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div>
        <h1 id="titleText">82-Day Clean Tracker</h1>
        <div class="subtitle">Track your custom clean streak — daily, weekly, or any duration</div>
      </div>
      <button class="btn ghost" onclick="openSetChallenge()">Set Challenge</button>
    </header>

    <div class="grid">
      <div class="card">
        <div class="muted">Challenge Progress</div>
        <div class="progress"><div class="bar" id="cleanBar"></div></div>
        <div style="display:flex;gap:12px;margin-top:8px;flex-wrap:wrap">
          <div class="muted">Clean Days: <strong id="cleanCount">0</strong></div>
          <div class="muted">Not Clean: <strong id="notCleanCount">0</strong></div>
          <div class="muted">Remaining: <strong id="remaining82">82</strong></div>
          <div class="muted">Goal: <strong id="goalText">82</strong> days</div>
        </div>

        <div class="progress" style="margin-top:12px"><div class="bar" id="yearbar"></div></div>
        <div class="muted" style="margin-top:8px">Timeline</div>
        <div class="timeline" id="timeline"></div>

        <div class="muted" style="margin-top:12px">Streaks</div>
        <div style="display:flex;gap:12px;margin-top:8px;flex-wrap:wrap">
          <div class="stat"><div class="num" id="currentStreak">0</div><div class="muted">Current</div></div>
          <div class="stat"><div class="num" id="longestStreak">0</div><div class="muted">Longest</div></div>
          <div class="stat"><div class="num" id="successRate">0%</div><div class="muted">Success</div></div>
        </div>

        <div class="muted" style="margin-top:12px">History</div>
        <div id="historyList" class="history"></div>

        <div style="display:flex;gap:10px;margin-top:10px;flex-wrap:wrap">
          <button class="btn" id="markClean">Mark Clean</button>
          <button class="btn ghost" id="markNotClean">Mark Not Clean</button>
          <button class="btn ghost" id="clearAll">Clear Data</button>
        </div>
      </div>

      <div class="card">
        <div class="muted">Tips to stay consistent</div>
        <ul style="color:var(--muted);padding-left:18px;margin-top:8px">
          <li>Start small — even 7 days counts.</li>
          <li>Write your reason before starting.</li>
          <li>Check your progress daily.</li>
          <li>Adjust your challenge duration anytime.</li>
        </ul>
      </div>
    </div>
  </div>

  <!-- Modal for custom challenge -->
  <div id="challengeModal" class="modal">
    <div class="sheet">
      <h3>Set Custom Challenge</h3>
      <label class="muted">Challenge Name</label>
      <input id="challengeNameInput" placeholder="e.g. 30-Day Clean Challenge">
      <label class="muted" style="margin-top:8px">Duration (days)</label>
      <input id="challengeDaysInput" type="number" min="1" max="365" value="82">
      <div style="display:flex;gap:8px;margin-top:12px;justify-content:flex-end">
        <button class="btn ghost" onclick="closeChallenge()">Cancel</button>
        <button class="btn" onclick="saveChallenge()">Save</button>
      </div>
    </div>
  </div>

<script>
(function(){
  const STORAGE = 'clean_tracker_pro_v2';
  const $ = id => document.getElementById(id);

  // State variables
  let GOAL = 82;
  let challengeName = "82-Day Clean Tracker";

  const state = JSON.parse(localStorage.getItem(STORAGE) || '{"entries":{}}');
  if (state.goal) GOAL = state.goal;
  if (state.name) challengeName = state.name;

  // Elements
  const cleanCountEl=$('cleanCount'), notCleanCountEl=$('notCleanCount'), remaining82El=$('remaining82');
  const cleanBar=$('cleanBar'), yearbar=$('yearbar');
  const currentStreakEl=$('currentStreak'), longestStreakEl=$('longestStreak'), successRateEl=$('successRate');
  const timelineEl=$('timeline'), historyList=$('historyList');
  const goalText=$('goalText'), titleText=$('titleText');

  function todayISO(d=new Date()){return d.toISOString().slice(0,10);}
  function parseISO(s){return new Date(s+'T00:00:00');}
  function save(){localStorage.setItem(STORAGE, JSON.stringify(state));}

  function getEntries(){return state.entries || {};}
  function addEntry(type){
    const iso=todayISO(); state.entries=state.entries||{};
    state.entries[iso]={type}; save(); refreshAll();
  }

  $('markClean').onclick=()=>addEntry('clean');
  $('markNotClean').onclick=()=>addEntry('not');
  $('clearAll').onclick=()=>{ if(confirm('Clear all data?')){ localStorage.removeItem(STORAGE); location.reload(); }};

  function recalcStats(){
    const entries=getEntries(); const dates=Object.keys(entries).sort();
    const cleanDates=dates.filter(d=>entries[d].type==='clean');
    const notDates=dates.filter(d=>entries[d].type==='not');
    cleanCountEl.textContent=cleanDates.length;
    notCleanCountEl.textContent=notDates.length;
    remaining82El.textContent=Math.max(0,GOAL-cleanDates.length);
    goalText.textContent=GOAL;
    titleText.textContent = challengeName || "Custom Clean Challenge";

    const pct=Math.min(100,Math.round((cleanDates.length/GOAL)*100));
    cleanBar.style.width=pct+'%';
    successRateEl.textContent=dates.length?Math.round((cleanDates.length/dates.length)*100)+'%':'0%';

    // streak calc
    const allDates=buildConsecutiveArray(dates);
    let longest=0,current=0;
    for(const d of allDates){if(entries[d]&&entries[d].type==='clean'){current++;if(current>longest)longest=current;}else current=0;}
    let streak=0;for(let i=allDates.length-1;i>=0;i--){const d=allDates[i];if(entries[d]&&entries[d].type==='clean')streak++;else break;}
    currentStreakEl.textContent=streak;longestStreakEl.textContent=longest;
  }

  function buildConsecutiveArray(dates){
    const arr=[]; for(let i=GOAL-1;i>=0;i--){const d=new Date();d.setDate(d.getDate()-i);arr.push(todayISO(d));}
    return arr;
  }

  function renderTimeline(){
    timelineEl.innerHTML=''; const entries=getEntries();
    for(let i=GOAL-1;i>=0;i--){const d=new Date();d.setDate(d.getDate()-i);const iso=todayISO(d);const obj=entries[iso];
      const dot=document.createElement('div'); dot.className='dot '+(obj?(obj.type==='clean'?'clean':'not'):'empty'); dot.title=iso;
      timelineEl.appendChild(dot);}
  }

  function renderHistory(){
    historyList.innerHTML=''; const entries=getEntries(); const list=Object.keys(entries).sort((a,b)=>b.localeCompare(a));
    if(list.length===0){historyList.innerHTML='<div class="muted">No entries yet.</div>';return;}
    list.forEach(d=>{const e=entries[d];const div=document.createElement('div');div.className='entry';div.innerHTML=`<div><div class="date">${d}</div><div class="type">${e.type==='clean'?'✅ Clean':'❌ Not Clean'}</div></div>`;historyList.appendChild(div);});
  }

  function refreshAll(){renderTimeline();renderHistory();recalcStats();}
  refreshAll();

  // Challenge Modal Functions
  window.openSetChallenge = function(){
    $('challengeDaysInput').value=GOAL;
    $('challengeNameInput').value=challengeName;
    $('challengeModal').style.display='flex';
  }
  window.closeChallenge = function(){
    $('challengeModal').style.display='none';
  }
  window.saveChallenge = function(){
    const n=parseInt($('challengeDaysInput').value);
    const name=$('challengeNameInput').value.trim()||'Custom Clean Challenge';
    if(isNaN(n)||n<=0){alert('Enter a valid number');return;}
    GOAL=n; challengeName=name;
    state.goal=n; state.name=name; save(); closeChallenge(); refreshAll();
    alert(`✅ Challenge set to "${name}" (${n} days)`);
  }

})();
</script>
</body>
</html>
